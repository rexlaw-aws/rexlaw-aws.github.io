
<!doctype html>
<html lang="zh-TW" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../pods/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.15">
    
    
      
        <title>身份和訪問管理 - EKS最佳實踐指南</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.7e359304.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳轉到
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="頁首">
    <a href="../../../" title="EKS最佳實踐指南" class="md-header__button md-logo" aria-label="EKS最佳實踐指南" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS最佳實踐指南
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              身份和訪問管理
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="選擇語言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../../security/docs/iam/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../../ko/security/docs/iam/" hreflang="ko" class="md-select__link">
              한국어
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../../zh/security/docs/iam/" hreflang="zh" class="md-select__link">
              中文（简体）
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="zh-TW" class="md-select__link">
              中文（繁體）
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜尋" placeholder="搜尋" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="搜尋">
        
        <button type="reset" class="md-search__icon md-icon" title="清除" aria-label="清除" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-eks-best-practices" title="前往倉庫" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="導覽列" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../" title="EKS最佳實踐指南" class="md-nav__button md-logo" aria-label="EKS最佳實踐指南" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS最佳實踐指南
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-eks-best-practices" title="前往倉庫" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    指南
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    簡介
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    安全
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            安全
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首頁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    身份和訪問管理
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    身份和訪問管理
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#eks" class="md-nav__link">
    <span class="md-ellipsis">
      控制對 EKS 叢集的存取
    </span>
  </a>
  
    <nav class="md-nav" aria-label="控制對 EKS 叢集的存取">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      叢集存取管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-auth-configmap" class="md-nav__link">
    <span class="md-ellipsis">
      aws-auth ConfigMap (已棄用)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      叢集存取建議
    </span>
  </a>
  
    <nav class="md-nav" aria-label="叢集存取建議">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eks_1" class="md-nav__link">
    <span class="md-ellipsis">
      使 EKS 叢集端點私有
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      不要使用服務帳戶權杖進行驗證
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws" class="md-nav__link">
    <span class="md-ellipsis">
      對 AWS 資源採用最小權限訪問
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-admin" class="md-nav__link">
    <span class="md-ellipsis">
      刪除叢集創建者主體的 cluster-admin 權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam" class="md-nav__link">
    <span class="md-ellipsis">
      當多個使用者需要對叢集的相同訪問權限時,請使用 IAM 角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rolebindings-clusterrolebindings" class="md-nav__link">
    <span class="md-ellipsis">
      在創建 RoleBindings 和 ClusterRoleBindings 時採用最小權限訪問
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      使用自動化過程創建叢集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam_1" class="md-nav__link">
    <span class="md-ellipsis">
      使用專用 IAM 角色創建叢集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      定期審核對叢集的訪問權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-auth-configmap_1" class="md-nav__link">
    <span class="md-ellipsis">
      如果依賴 aws-auth configMap,請使用工具進行更改
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      驗證和存取管理的替代方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eks-pods" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pods 的身分和憑證
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EKS Pods 的身分和憑證">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      Kubernetes 服務帳戶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam-irsa" class="md-nav__link">
    <span class="md-ellipsis">
      IAM 角色服務帳戶 (IRSA)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-pod" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pod 身分
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EKS Pod 身分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam-eks-pod" class="md-nav__link">
    <span class="md-ellipsis">
      使用 IAM 角色進行 EKS Pod 身分
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abac-eks-pod" class="md-nav__link">
    <span class="md-ellipsis">
      ABAC 和 EKS Pod 身分
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-pod-irsa" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pod 身分與 IRSA 的比較
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eks-pods_1" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pods 的身分和憑證建議
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EKS Pods 的身分和憑證建議">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-node-daemonset-irsa" class="md-nav__link">
    <span class="md-ellipsis">
      將 aws-node daemonset 更新為使用 IRSA
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      限制分配給工作節點的實例配置文件的訪問權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#irsa" class="md-nav__link">
    <span class="md-ellipsis">
      將 IRSA 角色的信任策略範圍縮小到服務帳戶名稱、命名空間和叢集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam_2" class="md-nav__link">
    <span class="md-ellipsis">
      每個應用程序使用一個 IAM 角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imds-imdsv2-ec2-2" class="md-nav__link">
    <span class="md-ellipsis">
      當您的應用程序需要訪問 IMDS 時,請使用 IMDSv2 並增加 EC2 實例的跳躍限制到 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      禁用服務帳戶令牌的自動掛載
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      為每個應用程序使用專用的服務帳戶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root" class="md-nav__link">
    <span class="md-ellipsis">
      以非 root 用戶運行應用程序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      向應用程序授予最小特權訪問權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks_2" class="md-nav__link">
    <span class="md-ellipsis">
      審查並撤銷對您的 EKS 叢集的不必要的匿名訪問
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#irsa-aws-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      與 IRSA 一起重複使用 AWS SDK 會話
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      替代方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      工具和資源
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pod 安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multitenancy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    多租戶
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../detective/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    偵查控制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    網絡安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    數據加密和密鑰管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    運行時安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hosts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基礎設施安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compliance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    監管合規性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../incidents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    事故響應和取證
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    映像安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiaccount/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    多帳戶策略
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    叢集自動擴展
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            叢集自動擴展
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../karpenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Karpenter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cluster-autoscaling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    叢集自動擴展器
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    可靠性
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            可靠性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首頁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/application/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    應用程式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/controlplane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/dataplane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    數據平面
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Windows 容器
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Windows 容器
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/ami/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMI 管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/gmsa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 容器的 gMSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/hardening/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows Server 強化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/images/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    掃描 Windows 映像
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/licensing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 版本和許可
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    日誌記錄
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    監控 Windows 容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 網絡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/oom/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    內存和系統管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/patching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基礎設施管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    調度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 容器的 Pod 安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    存儲選項
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    網絡
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            網絡
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首頁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VPC 和子網考量
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/vpc-cni/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Amazon VPC CNI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/ip-optimization-strategies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    優化 IP 地址利用率
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/ipv6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    運行 IPv6 叢集
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/custom-networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    自訂網路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/prefix-mode/index_linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux 的前綴模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/prefix-mode/index_windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 的前綴模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/sgpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    每個 Pod 的安全組
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/loadbalancing/loadbalancing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    負載均衡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    網絡性能問題監控
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    可擴展性
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            可擴展性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首頁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/control-plane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/data-plane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    數據平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/cluster-services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    叢集服務
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/workloads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工作負載
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/scaling_theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    擴展背後的理論
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/kcp_monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面監控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/node_efficiency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    節點效率和擴展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/kubernetes_slos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes SLO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/quotas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    已知限制和服務配額
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../upgrades/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    叢集升級
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    成本優化
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            成本優化
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cfm_framework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    雲端財務管理框架
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_compute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    計算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    網絡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    存儲
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    可觀察性
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#eks" class="md-nav__link">
    <span class="md-ellipsis">
      控制對 EKS 叢集的存取
    </span>
  </a>
  
    <nav class="md-nav" aria-label="控制對 EKS 叢集的存取">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      叢集存取管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-auth-configmap" class="md-nav__link">
    <span class="md-ellipsis">
      aws-auth ConfigMap (已棄用)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      叢集存取建議
    </span>
  </a>
  
    <nav class="md-nav" aria-label="叢集存取建議">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eks_1" class="md-nav__link">
    <span class="md-ellipsis">
      使 EKS 叢集端點私有
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      不要使用服務帳戶權杖進行驗證
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws" class="md-nav__link">
    <span class="md-ellipsis">
      對 AWS 資源採用最小權限訪問
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-admin" class="md-nav__link">
    <span class="md-ellipsis">
      刪除叢集創建者主體的 cluster-admin 權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam" class="md-nav__link">
    <span class="md-ellipsis">
      當多個使用者需要對叢集的相同訪問權限時,請使用 IAM 角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rolebindings-clusterrolebindings" class="md-nav__link">
    <span class="md-ellipsis">
      在創建 RoleBindings 和 ClusterRoleBindings 時採用最小權限訪問
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      使用自動化過程創建叢集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam_1" class="md-nav__link">
    <span class="md-ellipsis">
      使用專用 IAM 角色創建叢集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      定期審核對叢集的訪問權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-auth-configmap_1" class="md-nav__link">
    <span class="md-ellipsis">
      如果依賴 aws-auth configMap,請使用工具進行更改
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      驗證和存取管理的替代方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eks-pods" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pods 的身分和憑證
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EKS Pods 的身分和憑證">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      Kubernetes 服務帳戶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam-irsa" class="md-nav__link">
    <span class="md-ellipsis">
      IAM 角色服務帳戶 (IRSA)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-pod" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pod 身分
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EKS Pod 身分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam-eks-pod" class="md-nav__link">
    <span class="md-ellipsis">
      使用 IAM 角色進行 EKS Pod 身分
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abac-eks-pod" class="md-nav__link">
    <span class="md-ellipsis">
      ABAC 和 EKS Pod 身分
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-pod-irsa" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pod 身分與 IRSA 的比較
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eks-pods_1" class="md-nav__link">
    <span class="md-ellipsis">
      EKS Pods 的身分和憑證建議
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EKS Pods 的身分和憑證建議">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-node-daemonset-irsa" class="md-nav__link">
    <span class="md-ellipsis">
      將 aws-node daemonset 更新為使用 IRSA
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      限制分配給工作節點的實例配置文件的訪問權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#irsa" class="md-nav__link">
    <span class="md-ellipsis">
      將 IRSA 角色的信任策略範圍縮小到服務帳戶名稱、命名空間和叢集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam_2" class="md-nav__link">
    <span class="md-ellipsis">
      每個應用程序使用一個 IAM 角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imds-imdsv2-ec2-2" class="md-nav__link">
    <span class="md-ellipsis">
      當您的應用程序需要訪問 IMDS 時,請使用 IMDSv2 並增加 EC2 實例的跳躍限制到 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      禁用服務帳戶令牌的自動掛載
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      為每個應用程序使用專用的服務帳戶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root" class="md-nav__link">
    <span class="md-ellipsis">
      以非 root 用戶運行應用程序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      向應用程序授予最小特權訪問權限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks_2" class="md-nav__link">
    <span class="md-ellipsis">
      審查並撤銷對您的 EKS 叢集的不必要的匿名訪問
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#irsa-aws-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      與 IRSA 一起重複使用 AWS SDK 會話
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      替代方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      工具和資源
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="_1">身分識別與存取管理<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html">身分識別與存取管理</a> (IAM) 是 AWS 服務,可執行兩個基本功能:驗證和授權。驗證涉及身分的驗證,而授權則管理 AWS 資源可執行的動作。在 AWS 中,資源可以是另一個 AWS 服務,例如 EC2,或是 AWS <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/intro-structure.html#intro-structure-principal">主體</a>，如 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html#id_iam-users">IAM 使用者</a>或 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html#id_iam-roles">角色</a>。管理資源允許執行的動作的規則表示為 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html">IAM 政策</a>。</p>
<h2 id="eks">控制對 EKS 叢集的存取<a class="headerlink" href="#eks" title="Permanent link">&para;</a></h2>
<p>Kubernetes 專案支援多種不同的策略來驗證對 kube-apiserver 服務的請求,例如 Bearer Tokens、X.509 憑證、OIDC 等。EKS 目前原生支援 <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication">Webhook 權杖驗證</a>、<a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#service-account-tokens">服務帳戶權杖</a>,以及 2021 年 2 月 21 日的 OIDC 驗證。</p>
<p>Webhook 驗證策略會呼叫 Webhook 來驗證 Bearer 權杖。在 EKS 上,這些 Bearer 權杖是由 AWS CLI 或 <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator">aws-iam-authenticator</a> 客戶端產生,當您執行 <code>kubectl</code> 命令時。當您執行命令時,權杖會傳遞到 kube-apiserver,後者會將其轉發到驗證 Webhook。如果請求格式正確,Webhook 會呼叫權杖主體中嵌入的預簽名 URL。此 URL 會驗證請求的簽名,並向 kube-apiserver 返回有關使用者的資訊,例如使用者的帳戶、Arn 和 UserId。</p>
<p>要手動產生驗證權杖,請在終端機視窗中輸入以下命令:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>aws<span class="w"> </span>eks<span class="w"> </span>get-token<span class="w"> </span>--cluster-name<span class="w"> </span>&lt;cluster_name&gt;
</code></pre></div>
<p>您也可以以程式設計方式獲取權杖。以下是用 Go 編寫的範例:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="s">&quot;log&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="s">&quot;sigs.k8s.io/aws-iam-authenticator/pkg/token&quot;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">NewGenerator</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">  </span><span class="nx">tk</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;&lt;cluster_name&gt;&quot;</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">tk</span><span class="p">)</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="p">}</span>
</code></pre></div>
<p>輸出應該類似於此:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ExecCredential&quot;</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;client.authentication.k8s.io/v1alpha1&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nt">&quot;expirationTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-02-19T16:08:27Z&quot;</span><span class="p">,</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;k8s-aws-v1.aHR0cHM6Ly9zdHMuYW1hem9uYXdzLmNvbS8_QWN0aW9uPUdldENhbGxlcklkZW50aXR5JlZlcnNpb249MjAxMS0wNi0xNSZYLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFKTkdSSUxLTlNSQzJXNVFBJTJGMjAyMDAyMTklMkZ1cy1lYXN0LTElMkZzdHMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDIwMDIxOVQxNTU0MjdaJlgtQW16LUV4cGlyZXM9NjAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JTNCeC1rOHMtYXdzLWlkJlgtQW16LVNpZ25hdHVyZT0yMjBmOGYzNTg1ZTMyMGRkYjVlNjgzYTVjOWE0MDUzMDFhZDc2NTQ2ZjI0ZjI4MTExZmRhZDA5Y2Y2NDhhMzkz&quot;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="p">}</span>
</code></pre></div>
<p>每個權杖都以 <code>k8s-aws-v1.</code> 開頭,後面跟著一個 base64 編碼的字串。解碼該字串後,應該類似於以下內容:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>https://sts.amazonaws.com/?Action<span class="o">=</span>GetCallerIdentity<span class="p">&amp;</span><span class="nv">Version</span><span class="o">=</span><span class="m">2011</span>-06-15<span class="p">&amp;</span>X-Amz-Algorithm<span class="o">=</span>AWS4-HMAC-SHA256<span class="p">&amp;</span>X-Amz-Credential<span class="o">=</span>XXXXJPFRILKNSRC2W5QA%2F20200219%2Fus-xxxx-1%2Fsts%2Faws4_request<span class="p">&amp;</span>X-Amz-Date<span class="o">=</span>20200219T155427Z<span class="p">&amp;</span>X-Amz-Expires<span class="o">=</span><span class="m">60</span><span class="p">&amp;</span>X-Amz-SignedHeaders<span class="o">=</span>host%3Bx-k8s-aws-id<span class="p">&amp;</span>X-Amz-Signature<span class="o">=</span>XXXf8f3285e320ddb5e683a5c9a405301ad76546f24f28111fdad09cf648a393
</code></pre></div>
<p>權杖由包含 Amazon 憑證和簽名的預簽名 URL 組成。有關更多詳細資訊,請參閱 <a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html">https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html</a>。</p>
<p>權杖的生存時間 (TTL) 為 15 分鐘,之後需要生成新的權杖。當您使用 <code>kubectl</code> 等客戶端時,這是自動處理的,但是如果您使用 Kubernetes 儀表板,則需要在權杖過期時生成新的權杖並重新驗證。</p>
<p>一旦 AWS IAM 服務驗證了使用者的身分,kube-apiserver 就會讀取 <code>kube-system</code> 命名空間中的 <code>aws-auth</code> ConfigMap,以確定要與使用者關聯的 RBAC 群組。<code>aws-auth</code> ConfigMap 用於在 IAM 主體(即 IAM 使用者和角色)和 Kubernetes RBAC 群組之間創建靜態映射。RBAC 群組可以在 Kubernetes RoleBindings 或 ClusterRoleBindings 中引用。它們類似於 IAM 角色,因為它們定義了可以對一組 Kubernetes 資源(物件)執行的一組操作(動詞)。</p>
<h3 id="_2">叢集存取管理器<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>叢集存取管理器是 AWS API 的一項功能,是 EKS v1.23 及更高版本叢集(新的或現有的)的一項選擇性功能。它簡化了 AWS IAM 和 Kubernetes RBAC 之間的身分映射,消除了在 AWS 和 Kubernetes API 之間切換或編輯 <code>aws-auth</code> ConfigMap 進行存取管理的需要,從而減少了運營開銷,並有助於解決自動授予創建叢集的 AWS IAM 主體 <code>cluster-admin</code> 權限的問題。</p>
<p>此 API 依賴於兩個概念:</p>
<ul>
<li><strong>存取項目:</strong> 直接與允許驗證到 Amazon EKS 叢集的 AWS IAM 主體(使用者或角色)相關的叢集身分。</li>
<li><strong>存取政策:</strong> 是 Amazon EKS 特定的政策,提供授權存取項目在 Amazon EKS 叢集中執行操作的授權。</li>
</ul>
<blockquote>
<p>在發布時,Amazon EKS 只支持預定義和 AWS 管理的政策。存取政策不是 IAM 實體,而是由 Amazon EKS 定義和管理的。</p>
</blockquote>
<p>叢集存取管理器允許將上游 RBAC 與支持允許和傳遞(但不拒絕)的存取政策相結合,以對 Kubernetes AuthZ 決策進行 API 伺服器請求。當上游 RBAC 和 Amazon EKS 授權器都無法確定請求評估的結果時,會發生拒絕決定。</p>
<p>通過此功能,Amazon EKS 支持三種驗證模式:</p>
<ol>
<li><code>CONFIG_MAP</code> 繼續僅使用 <code>aws-auth</code> configMap。</li>
<li><code>API_AND_CONFIG_MAP</code> 從 EKS 存取項目 API 和 <code>aws-auth</code> configMap 中獲取經過驗證的 IAM 主體,優先考慮存取項目。這是遷移現有的 <code>aws-auth</code> 權限到存取項目的理想選擇。</li>
<li><code>API</code> 完全依賴 EKS 存取項目 API。這是新的<strong>推薦方法</strong>。</li>
</ol>
<p>要開始使用,叢集管理員可以創建或更新 Amazon EKS 叢集,將首選驗證設置為 <code>API_AND_CONFIG_MAP</code> 或 <code>API</code> 方法,並定義存取項目以授予所需的 AWS IAM 主體訪問權限。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>create-cluster<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span>--name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span>--role-arn<span class="w"> </span>&lt;CLUSTER_ROLE_ARN&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span>--resources-vpc-config<span class="w"> </span><span class="nv">subnetIds</span><span class="o">=</span>&lt;value&gt;,endpointPublicAccess<span class="o">=</span>true,endpointPrivateAccess<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span>--logging<span class="w"> </span><span class="s1">&#39;{&quot;clusterLogging&quot;:[{&quot;types&quot;:[&quot;api&quot;,&quot;audit&quot;,&quot;authenticator&quot;,&quot;controllerManager&quot;,&quot;scheduler&quot;],&quot;enabled&quot;:true}]}&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span>--access-config<span class="w"> </span><span class="nv">authenticationMode</span><span class="o">=</span>API_AND_CONFIG_MAP,bootstrapClusterCreatorAdminPermissions<span class="o">=</span><span class="nb">false</span>
</code></pre></div>
<p>上述命令是一個示例,用於創建一個 Amazon EKS 叢集,而不授予叢集創建者管理員權限。</p>
<p>可以使用 <code>update-cluster-config</code> 命令更新 Amazon EKS 叢集配置以啟用 <code>API</code> 驗證模式,要在使用 <code>CONFIG_MAP</code> 的現有叢集上執行此操作,您必須先更新為 <code>API_AND_CONFIG_MAP</code>,然後再更新為 <code>API</code>。<strong>這些操作不能撤消</strong>,這意味著無法從 <code>API</code> 切換到 <code>API_AND_CONFIG_MAP</code> 或 <code>CONFIG_MAP</code>,也無法從 <code>API_AND_CONFIG_MAP</code> 切換到 <code>CONFIG_MAP</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>update-cluster-config<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span>--name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span>--access-config<span class="w"> </span><span class="nv">authenticationMode</span><span class="o">=</span>API
</code></pre></div>
<p>該 API 支持添加和撤銷對叢集的訪問權限,以及驗證指定叢集的現有存取政策和存取項目。預設政策是根據以下 Kubernets RBAC 創建的。</p>
<table>
<thead>
<tr>
<th>EKS 存取政策</th>
<th>Kubernetes RBAC</th>
</tr>
</thead>
<tbody>
<tr>
<td>AmazonEKSClusterAdminPolicy</td>
<td>cluster-admin</td>
</tr>
<tr>
<td>AmazonEKSAdminPolicy</td>
<td>admin</td>
</tr>
<tr>
<td>AmazonEKSEditPolicy</td>
<td>edit</td>
</tr>
<tr>
<td>AmazonEKSViewPolicy</td>
<td>view</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>list-access-policies
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="o">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="s2">&quot;accessPolicies&quot;</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="o">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;AmazonEKSAdminPolicy&quot;</span>,
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">            </span><span class="s2">&quot;arn&quot;</span>:<span class="w"> </span><span class="s2">&quot;arn:aws:eks::aws:cluster-access-policy/AmazonEKSAdminPolicy&quot;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="o">}</span>,
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="o">{</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;AmazonEKSClusterAdminPolicy&quot;</span>,
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">            </span><span class="s2">&quot;arn&quot;</span>:<span class="w"> </span><span class="s2">&quot;arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="o">}</span>,
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="o">{</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;AmazonEKSEditPolicy&quot;</span>,
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">            </span><span class="s2">&quot;arn&quot;</span>:<span class="w"> </span><span class="s2">&quot;arn:aws:eks::aws:cluster-access-policy/AmazonEKSEditPolicy&quot;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">        </span><span class="o">}</span>,
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">        </span><span class="o">{</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;AmazonEKSViewPolicy&quot;</span>,
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">            </span><span class="s2">&quot;arn&quot;</span>:<span class="w"> </span><span class="s2">&quot;arn:aws:eks::aws:cluster-access-policy/AmazonEKSViewPolicy&quot;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">        </span><span class="o">}</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">    </span><span class="o">]</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="o">}</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>list-access-entries<span class="w"> </span>--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="o">{</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span><span class="s2">&quot;accessEntries&quot;</span>:<span class="w"> </span><span class="o">[]</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="o">}</span>
</code></pre></div>
<blockquote>
<p>當叢集在沒有叢集創建者管理員權限的情況下創建時,沒有可用的存取項目,這是默認創建的唯一項目。</p>
</blockquote>
<h3 id="aws-auth-configmap"><code>aws-auth</code> ConfigMap <em>(已棄用)</em><a class="headerlink" href="#aws-auth-configmap" title="Permanent link">&para;</a></h3>
<p>Kubernetes 與 AWS 驗證集成的一種方式是通過 <code>kube-system</code> 命名空間中的 <code>aws-auth</code> ConfigMap。它負責將 AWS IAM 身分(使用者、群組和角色)驗證映射到 Kubernetes 基於角色的存取控制 (RBAC) 授權。<code>aws-auth</code> ConfigMap 在 Amazon EKS 叢集配置期間自動創建。它最初是為了允許節點加入您的叢集而創建的,但如前所述,您也可以使用此 ConfigMap 為 IAM 主體添加 RBAC 訪問權限。</p>
<p>要檢查您叢集的 <code>aws-auth</code> ConfigMap,可以使用以下命令。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>aws-auth<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<p>這是 <code>aws-auth</code> ConfigMap 的默認配置示例。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nt">mapRoles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="no">- groups:</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">      </span><span class="no">- system:bootstrappers</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">      </span><span class="no">- system:nodes</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">      </span><span class="no">- system:node-proxier</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">      </span><span class="no">rolearn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/kube-system-&lt;SELF_GENERATED_UUID&gt;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">      </span><span class="no">username: system:node:{{SessionName}}</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-22T18:19:30Z&quot;</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-auth</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</code></pre></div>
<p>此 ConfigMap 的主要部分位於 <code>data</code> 下的 <code>mapRoles</code> 塊中,由 3 個參數組成。</p>
<ul>
<li><strong>groups:</strong> 要將 IAM 角色映射到的 Kubernetes 群組。這可以是默認群組,也可以是在 <code>clusterrolebinding</code> 或 <code>rolebinding</code> 中指定的自定義群組。在上面的示例中,我們只有系統群組被聲明。</li>
<li><strong>rolearn:</strong> 要映射到 Kubernetes 群組的 AWS IAM 角色的 ARN,使用以下格式 <code>arn:&lt;PARTITION&gt;:iam::&lt;AWS_ACCOUNT_ID&gt;:role/role-name</code>。</li>
<li><strong>username:</strong> 在 Kubernetes 中映射到 AWS IAM 角色的用戶名。這可以是任何自定義名稱。</li>
</ul>
<blockquote>
<p>也可以在 <code>aws-auth</code> ConfigMap 的 <code>data</code> 下定義一個新的 <code>mapUsers</code> 配置塊來映射 AWS IAM 使用者的權限,但將 <strong>rolearn</strong> 參數替換為 <strong>userarn</strong>,但作為<strong>最佳實踐</strong>,始終建議使用 <code>mapRoles</code>。</p>
</blockquote>
<p>要管理權限,您可以編輯 <code>aws-auth</code> ConfigMap,添加或刪除對您的 Amazon EKS 叢集的訪問權限。雖然可以手動編輯 <code>aws-auth</code> ConfigMap,但建議使用像 <code>eksctl</code> 這樣的工具,因為這是一個非常敏感的配置,不準確的配置可能會將您鎖定在 Amazon EKS 叢集之外。有關更多詳細資訊,請參閱下面的<a href="https://aws.github.io/aws-eks-best-practices/security/docs/iam/#use-tools-to-make-changes-to-the-aws-auth-configmap">使用工具對 aws-auth ConfigMap 進行更改</a>小節。</p>
<h2 id="_3">叢集存取建議<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="eks_1">使 EKS 叢集端點私有<a class="headerlink" href="#eks_1" title="Permanent link">&para;</a></h3>
<p>默認情況下,當您配置 EKS 叢集時,API 叢集端點被設置為公開的,即可從互聯網訪問。儘管可從互聯網訪問,但端點仍被視為安全,因為它要求所有 API 請求都由 IAM 進行驗證,然後由 Kubernetes RBAC 授權。但是,如果您的公司安全政策要求您限制從互聯網訪問 API,或者阻止您在叢集 VPC 外路由流量,您可以:</p>
<ul>
<li>將 EKS 叢集端點配置為私有。有關此主題的更多資訊,請參閱<a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html">修改叢集端點訪問</a>。</li>
<li>保留公開的叢集端點,並指定哪些 CIDR 塊可以與叢集端點通信。這些塊實際上是允許訪問叢集端點的公共 IP 地址的白名單。</li>
<li>配置公共訪問,並設置一組白名單 CIDR 塊,並啟用私有端點訪問。這將允許來自特定公共 IP 範圍的公共訪問,同時強制 kubelets(工作節點)與 Kubernetes API 之間的所有網路流量通過在配置控制平面時配置到叢集 VPC 的跨帳戶 ENI。</li>
</ul>
<h3 id="_4">不要使用服務帳戶權杖進行驗證<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>服務帳戶權杖是一個長期的靜態憑證。如果它被洩露、丟失或被盜,攻擊者可能能夠執行與該權杖相關的所有操作,直到刪除該服務帳戶。有時,您可能需要為在叢集外部使用 Kubernetes API 的應用程式(例如 CI/CD 管道應用程式)授予例外。如果這些應用程式在 AWS 基礎設施(如 EC2 實例)上運行,請考慮使用實例配置文件並將其映射到 Kubernetes RBAC 角色。</p>
<h3 id="aws">對 AWS 資源採用最小權限訪問<a class="headerlink" href="#aws" title="Permanent link">&para;</a></h3>
<p>IAM 使用者不需要被分配 AWS 資源的權限來訪問 Kubernetes API。如果您需要授予 IAM 使用者訪問 EKS 叢集的權限,請在 <code>aws-auth</code> ConfigMap 中為該使用者創建一個條目,將其映射到特定的 Kubernetes RBAC 群組。</p>
<h3 id="cluster-admin">刪除叢集創建者主體的 cluster-admin 權限<a class="headerlink" href="#cluster-admin" title="Permanent link">&para;</a></h3>
<p>默認情況下,Amazon EKS 叢集是使用永久的 <code>cluster-admin</code> 權限創建的,該權限綁定到叢集創建者主體。使用叢集存取管理器 API,可以在使用 <code>API_AND_CONFIG_MAP</code> 或 <code>API</code> 驗證模式時,通過設置 <code>--access-config bootstrapClusterCreatorAdminPermissions</code> 為 <code>false</code> 來創建沒有此權限的叢集。撤銷此訪問被視為最佳實踐,以避免對叢集配置進行任何不必要的更改。撤銷此訪問的過程遵循撤銷任何其他對叢集的訪問的相同過程。</p>
<p>該 API 使您能夠僅取消 IAM 主體與存取政策的關聯,在本例中為 <code>AmazonEKSClusterAdminPolicy</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>list-associated-access-policies<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span>--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span>--principal-arn<span class="w"> </span>&lt;IAM_PRINCIPAL_ARN&gt;
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>disassociate-access-policy<span class="w"> </span>--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span>--principal-arn<span class="w"> </span>&lt;IAM_PRINCIPAL_ARN.<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span>--policy-arn<span class="w"> </span>arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
</code></pre></div>
<p>或者完全刪除與 <code>cluster-admin</code> 權限關聯的存取項目。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>list-access-entries<span class="w"> </span>--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="o">{</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="s2">&quot;accessEntries&quot;</span>:<span class="w"> </span><span class="o">[]</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="o">}</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>delete-access-entry<span class="w"> </span>--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">  </span>--principal-arn<span class="w"> </span>&lt;IAM_PRINCIPAL_ARN&gt;
</code></pre></div>
<blockquote>
<p>如果在事故、緊急情況或緊急情況下叢集無法訪問,則可以重新授予此訪問權限。</p>
</blockquote>
<p>如果叢集仍使用 <code>CONFIG_MAP</code> 驗證方法,所有其他使用者都應通過 <code>aws-auth</code> ConfigMap 獲得對叢集的訪問權限,並在配置 <code>aws-auth</code> ConfigMap 後,可以刪除創建叢集的實體的角色,並僅在事故、緊急情況或緊急情況下或 <code>aws-auth</code> ConfigMap 已損壞且叢集無法訪問時重新創建。這在生產叢集中特別有用。</p>
<h3 id="iam">當多個使用者需要對叢集的相同訪問權限時,請使用 IAM 角色<a class="headerlink" href="#iam" title="Permanent link">&para;</a></h3>
<p>而不是為每個個別 IAM 使用者創建一個條目,允許這些使用者承擔一個 IAM 角色,並將該角色映射到一個 Kubernetes RBAC 群組。這將更容易維護,尤其是當需要訪問的使用者數量增加時。</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>當使用 <code>aws-auth</code> ConfigMap 映射的 IAM 實體訪問 EKS 叢集時,Kubernetes 審核日誌中記錄的用戶名是 <code>aws-auth</code> ConfigMap 中描述的用戶名。如果您使用 IAM 角色,則無法審核實際承擔該角色的用戶。</p>
</div>
<p>如果仍在使用 <code>aws-auth</code> configMap 作為驗證方法,在將 K8s RBAC 權限分配給 IAM 角色時,您應該包括 {{SessionName}} 在您的用戶名中。這樣,審核日誌就會記錄會話名稱,以便您可以跟踪實際承擔此角色的用戶,以及 CloudTrail 日誌。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rolearn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::XXXXXXXXXXXX:role/testRole</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testRole:{{SessionName}}</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="nt">groups</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:masters</span>
</code></pre></div>
<blockquote>
<p>在 Kubernetes 1.20 及更高版本中,不再需要此更改,因為 <code>user.extra.sessionName.0</code> 已添加到 Kubernetes 審核日誌中。</p>
</blockquote>
<h3 id="rolebindings-clusterrolebindings">在創建 RoleBindings 和 ClusterRoleBindings 時採用最小權限訪問<a class="headerlink" href="#rolebindings-clusterrolebindings" title="Permanent link">&para;</a></h3>
<p>與前面提到的授予對 AWS 資源的訪問權限一樣,RoleBindings 和 ClusterRoleBindings 應該只包含執行特定功能所需的一組權限。除非絕對必要,否則請避免在您的角色和 ClusterRoles 中使用 <code>["*"]</code>。如果您不確定要分配哪些權限,請考慮使用像 <a href="https://github.com/liggitt/audit2rbac">audit2rbac</a> 這樣的工具,根據 Kubernetes 審核日誌中觀察到的 API 調用自動生成角色和綁定。</p>
<h3 id="_5">使用自動化過程創建叢集<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>如前面的步驟所示,在創建 Amazon EKS 叢集時,如果不使用 <code>API_AND_CONFIG_MAP</code> 或 <code>API</code> 驗證模式,並且不選擇將 <code>cluster-admin</code> 權限委派給叢集創建者,則創建叢集的 IAM 實體用戶或角色(如聯合用戶)會自動獲得 <code>system:masters</code> 權限。即使刪除此權限是最佳實踐(如<a href="#remove-the-cluster-admin-permissions-from-the-cluster-creator-principal">刪除叢集創建者主體的 cluster-admin 權限</a>所述),但如果使用 <code>CONFIG_MAP</code> 驗證方法,依賴 <code>aws-auth</code> ConfigMap,此訪問權限也無法撤銷。因此,最好使用與專用 IAM 角色綁定的基礎設施自動化管道來創建叢集,該角色沒有被其他用戶或實體承擔的權限,並定期審核此角色的權限、策略和誰有權觸發管道。此角色也不應用於對叢集執行日常操作,而應僅用於由管道觸發的叢集級別操作,例如通過 SCM 代碼更改。</p>
<h3 id="iam_1">使用專用 IAM 角色創建叢集<a class="headerlink" href="#iam_1" title="Permanent link">&para;</a></h3>
<p>當您創建 Amazon EKS 叢集時,創建叢集的 IAM 實體用戶或角色(如聯合用戶)會自動獲得 <code>system:masters</code> 權限。此訪問權限無法刪除,也不通過 <code>aws-auth</code> ConfigMap 進行管理。因此,最好使用專用 IAM 角色創建叢集,並定期審核誰可以承擔此角色。此角色不應用於對叢集執行日常操作,而應通過 <code>aws-auth</code> ConfigMap 為其他使用者授予對叢集的訪問權限。配置 <code>aws-auth</code> ConfigMap 後,應該保護該角色並僅在臨時提升權限模式/緊急情況下使用,例如在叢集無法訪問的情況下。這在沒有直接用戶訪問配置的叢集中特別有用。</p>
<h3 id="_6">定期審核對叢集的訪問權限<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>隨著時間的推移,需要訪問的人可能會發生變化。計劃定期審核 <code>aws-auth</code> ConfigMap,查看誰被授予了訪問權限以及分配給他們的權限。您還可以使用像 <a href="https://github.com/aquasecurity/kubectl-who-can">kubectl-who-can</a> 或 <a href="https://github.com/FairwindsOps/rbac-lookup">rbac-lookup</a> 這樣的開源工具來檢查綁定到特定服務帳戶、用戶或群組的角色。我們將在<a href="../detective/">審核</a>部分進一步探討這個主題。這篇<a href="https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2019/august/tools-and-methods-for-auditing-kubernetes-rbac-policies/?mkt_tok=eyJpIjoiWWpGa056SXlNV1E0WWpRNSIsInQiOiJBT1hyUTRHYkg1TGxBV0hTZnRibDAyRUZ0VzBxbndnRzNGbTAxZzI0WmFHckJJbWlKdE5WWDdUQlBrYVZpMnNuTFJ1R3hacVYrRCsxYWQ2RTRcL2pMN1BtRVA1ZFZcL0NtaEtIUDdZV3pENzNLcE1zWGVwUndEXC9Pb2tmSERcL1pUaGUifQ%3D%3D">文章</a>中也有更多想法。</p>
<h3 id="aws-auth-configmap_1">如果依賴 <code>aws-auth</code> configMap,請使用工具進行更改<a class="headerlink" href="#aws-auth-configmap_1" title="Permanent link">&para;</a></h3>
<p>格式不正確的 aws-auth ConfigMap 可能會導致您失去對叢集的訪問權限。如果您需要對 ConfigMap 進行更改,請使用工具。</p>
<p><strong>eksctl</strong>
<code>eksctl</code> CLI 包括一個用於將身分映射添加到 aws-auth ConfigMap 的命令。</p>
<p>查看 CLI 幫助:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span>eksctl<span class="w"> </span>create<span class="w"> </span>iamidentitymapping<span class="w"> </span>--help
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>...
</code></pre></div>
<p>檢查映射到您的 Amazon EKS 叢集的身分。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$<span class="w"> </span>eksctl<span class="w"> </span>get<span class="w"> </span>iamidentitymapping<span class="w"> </span>--cluster<span class="w"> </span><span class="nv">$CLUSTER_NAME</span><span class="w"> </span>--region<span class="w"> </span><span class="nv">$AWS_REGION</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>ARN<span class="w">                                                                   </span>USERNAME<span class="w">                        </span>GROUPS<span class="w">                                                  </span>ACCOUNT
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>arn:aws:iam::788355785855:role/kube-system-&lt;SELF_GENERATED_UUID&gt;<span class="w">      </span>system:node:<span class="o">{{</span>SessionName<span class="o">}}</span><span class="w">     </span>system:bootstrappers,system:nodes,system:node-proxier<span class="w">  </span>
</code></pre></div>
<p>使 IAM 角色成為叢集管理員:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>eksctl<span class="w"> </span>create<span class="w"> </span>iamidentitymapping<span class="w"> </span>--cluster<span class="w">  </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span>--region<span class="o">=</span>&lt;region&gt;<span class="w"> </span>--arn<span class="w"> </span>arn:aws:iam::123456:role/testing<span class="w"> </span>--group<span class="w"> </span>system:masters<span class="w"> </span>--username<span class="w"> </span>admin
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>...
</code></pre></div>
<p>有關更多資訊,請查看 <a href="https://eksctl.io/usage/iam-identity-mappings/"><code>eksctl</code> 文檔</a></p>
<p><strong><a href="https://github.com/keikoproj/aws-auth">keikoproj 的 aws-auth</a></strong></p>
<p>keikoproj 的 <code>aws-auth</code> 包括 cli 和 go 庫。</p>
<p>下載並查看 CLI 幫助:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$<span class="w"> </span>go<span class="w"> </span>get<span class="w"> </span>github.com/keikoproj/aws-auth
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>...
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>$<span class="w"> </span>aws-auth<span class="w"> </span><span class="nb">help</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>...
</code></pre></div>
<p>或者,使用 <a href="https://krew.sigs.k8s.io">krew 插件管理器</a>為 kubectl 安裝 <code>aws-auth</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>krew<span class="w"> </span>install<span class="w"> </span>aws-auth
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>...
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>$<span class="w"> </span>kubectl<span class="w"> </span>aws-auth
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>...
</code></pre></div>
<p><a href="https://github.com/keikoproj/aws-auth/blob/master/README.md">在 GitHub 上查看 aws-auth 文檔</a>,了解更多資訊,包括 go 庫。</p>
<p><strong><a href="https://github.com/kubernetes-sigs/aws-iam-authenticator/tree/master/cmd/aws-iam-authenticator">AWS IAM 驗證器 CLI</a></strong></p>
<p><code>aws-iam-authenticator</code> 項目包括一個 CLI,用於更新 ConfigMap。</p>
<p><a href="https://github.com/kubernetes-sigs/aws-iam-authenticator/releases">在 GitHub 上下載一個版本</a>。</p>
<p>將叢集權限添加到 IAM 角色:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$<span class="w"> </span>./aws-iam-authenticator<span class="w"> </span>add<span class="w"> </span>role<span class="w"> </span>--rolearn<span class="w"> </span>arn:aws:iam::185309785115:role/lil-dev-role-cluster<span class="w"> </span>--username<span class="w"> </span>lil-dev-user<span class="w"> </span>--groups<span class="w"> </span>system:masters<span class="w"> </span>--kubeconfig<span class="w"> </span>~/.kube/config
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>...
</code></pre></div>
<h3 id="_7">驗證和存取管理的替代方法<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>雖然 IAM 是訪問 EKS 叢集的首選方式,但也可以使用 OIDC 身分提供程式(如 GitHub)和 Kubernetes <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation">模擬</a>。AWS 開源博客上發布了兩種這樣的解決方案:</p>
<ul>
<li><a href="https://aws.amazon.com/blogs/opensource/authenticating-eks-github-credentials-teleport/">使用 Teleport 通過 GitHub 憑證對 EKS 進行驗證</a></li>
<li><a href="https://aws.amazon.com/blogs/opensource/consistent-oidc-authentication-across-multiple-eks-clusters-using-kube-oidc-proxy/">使用 kube-oidc-proxy 跨多個 EKS 叢集實現一致的 OIDC 驗證</a></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>EKS 原生支持 OIDC 驗證,無需使用代理。有關更多資訊,請閱讀發布博客<a href="https://aws.amazon.com/blogs/containers/introducing-oidc-identity-provider-authentication-amazon-eks/">為 Amazon EKS 引入 OIDC 身分提供程式驗證</a>。有關如何使用 Dex(一個流行的開源 OIDC 提供程式,具有各種不同驗證方法的連接器)配置 EKS 的示例,請參閱<a href="https://aws.amazon.com/blogs/containers/using-dex-dex-k8s-authenticator-to-authenticate-to-amazon-eks/">使用 Dex &amp; dex-k8s-authenticator 對 Amazon EKS 進行驗證</a>。如博客所述,通過 OIDC 提供程式驗證的用戶名/群組將出現在 Kubernetes 審核日誌中。</p>
</div>
<p>您還可以使用 <a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html">AWS SSO</a> 將 AWS 與外部身分提供程式(如 Azure AD)聯合。如果您決定使用它,AWS CLI v2.0 包括一個選項,可以創建一個命名配置文件,使其容易將 SSO 會話與您當前的 CLI 會話相關聯並承擔一個 IAM 角色。請注意,您必須在運行 <code>kubectl</code> 之前先承擔一個角色,因為 IAM 角色用於確定用戶的 Kubernetes RBAC 群組。</p>
<h2 id="eks-pods">EKS Pods 的身分和憑證<a class="headerlink" href="#eks-pods" title="Permanent link">&para;</a></h2>
<p>某些在 Kubernetes 叢集內運行的應用程式需要權限來調用 Kubernetes API 才能正常運行。例如,<a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller">AWS Load Balancer Controller</a> 需要能夠列出服務的端點。該控制器還需要能夠調用 AWS API 來配置和配置 ALB。在本節中,我們將探討為 Pods 分配權限和特權的最佳實踐。</p>
<h3 id="kubernetes">Kubernetes 服務帳戶<a class="headerlink" href="#kubernetes" title="Permanent link">&para;</a></h3>
<p>服務帳戶是一種特殊類型的對象,允許您將 Kubernetes RBAC 角色分配給 pod。每個命名空間中都會自動創建一個默認服務帳戶。當您在不引用特定服務帳戶的情況下將 pod 部署到命名空間中時,該命名空間的默認服務帳戶將自動分配給 Pod,並且該服務帳戶(JWT)令牌將作為卷掛載到 pod 的 <code>/var/run/secrets/kubernetes.io/serviceaccount</code> 目錄中。解碼該目錄中的服務帳戶令牌將揭示以下元數據:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes/serviceaccount&quot;</span><span class="p">,</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/secret.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default-token-5pv4z&quot;</span><span class="p">,</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/service-account.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/service-account.uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3b36ddb5-438c-11ea-9438-063a49b60fba&quot;</span><span class="p">,</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:default&quot;</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="p">}</span>
</code></pre></div>
<p>默認服務帳戶對 Kubernetes API 具有以下權限。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">    </span><span class="nt">rbac.authorization.kubernetes.io/autoupdate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2020-01-30T18:13:25Z&quot;</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="nt">kubernetes.io/bootstrapping</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac-defaults</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:discovery</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;43&quot;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis/rbac.authorization.k8s.io/v1/clusterroles/system%3Adiscovery</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">350d2ab8-438c-11ea-9438-063a49b60fba</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">nonResourceURLs</span><span class="p">:</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/api</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/api/*</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis/*</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/healthz</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/openapi</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/openapi/*</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/version</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/version/</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
</code></pre></div>
<p>此角色授權未經驗證和經過驗證的用戶讀取 API 資訊,被認為是安全的公開訪問。</p>
<p>當應用程式在 Pod 內部調用 Kubernetes API 時,Pod 需要被分配一個顯式授予它調用這些 API 的權限的服務帳戶。類似於用戶訪問的指南,綁定到服務帳戶的角色或 ClusterRole 應該限制為應用程式需要才能正常運行的 API 資源和方法,而不是其他。要使用非默認服務帳戶,只需將 Pod 的 <code>spec.serviceAccountName</code> 字段設置為您要使用的服務帳戶的名稱。有關創建服務帳戶的更多資訊,請參見 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions">https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions</a>。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在 Kubernetes 1.24 之前,Kubernetes 會自動為每個服務帳戶創建一個密鑰。這個密鑰被掛載到 pod 的 /var/run/secrets/kubernetes.io/serviceaccount 中,並由 pod 用於對 Kubernetes API 伺服器進行驗證。在 Kubernetes 1.24 中,當 pod 運行時會動態生成一個服務帳戶令牌,默認有效期為 1 小時。不會創建服務帳戶的密鑰。如果您有一個在叢集外部運行並需要對 Kubernetes API 進行驗證的應用程式(例如 Jenkins),您需要創建一個類型為 <code>kubernetes.io/service-account-token</code> 的密鑰,並添加一個引用服務帳戶名稱的註釋,如 <code>metadata.annotations.kubernetes.io/service-account.name: &lt;SERVICE_ACCOUNT_NAME&gt;</code>。這樣創建的密鑰不會過期。</p>
</div>
<h3 id="iam-irsa">IAM 角色服務帳戶 (IRSA)<a class="headerlink" href="#iam-irsa" title="Permanent link">&para;</a></h3>
<p>IRSA 是一項功能,允許您將 IAM 角色分配給 Kubernetes 服務帳戶。它利用 Kubernetes 的一項功能,稱為<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#serviceaccount-token-volume-projection">服務帳戶令牌卷投射</a>。當 Pods 配置有引用 IAM 角色的服務帳戶時,Kubernetes API 伺服器將在啟動時調用叢集的公共 OIDC 發現端點。該端點以密碼方式簽署 Kubernetes 發出的 OIDC 令牌,並將其掛載為卷。這個簽名的令牌允許 Pod 調用與 IAM 角色關聯的 AWS API。當調用 AWS API 時,AWS SDK 會調用 <code>sts:AssumeRoleWithWebIdentity</code>。在驗證令牌的簽名後,IAM 會交換 Kubernetes 發出的令牌以獲取臨時的 AWS 角色憑證。</p>
<p>使用 IRSA 時,重要的是<a href="#reuse-aws-sdk-sessions-with-irsa">重複使用 AWS SDK 會話</a>以避免對 AWS STS 的不必要調用。</p>
<p>解碼 IRSA 的(JWT)令牌將產生類似於以下示例的輸出:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="s2">&quot;sts.amazonaws.com&quot;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1582306514</span><span class="p">,</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1582220114</span><span class="p">,</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/D43CF17C27A865933144EA99A26FB128&quot;</span><span class="p">,</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">  </span><span class="nt">&quot;kubernetes.io&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">    </span><span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">    </span><span class="nt">&quot;pod&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;alpine-57b5664646-rf966&quot;</span><span class="p">,</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5a20f883-5407-11ea-a85c-0e62b7a4a436&quot;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">    </span><span class="nt">&quot;serviceaccount&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3-read-only&quot;</span><span class="p">,</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a720ba5c-5406-11ea-9438-063a49b60fba&quot;</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1582220114</span><span class="p">,</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:s3-read-only&quot;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="p">}</span>
</code></pre></div>
<p>這個特定的令牌授予 Pod 對 S3 的只讀權限,通過承擔一個 IAM 角色來實現。當應用程式嘗試從 S3 讀取時,該令牌將被交換為類似於以下內容的臨時 IAM 憑證:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="nt">&quot;AssumedRoleUser&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">        </span><span class="nt">&quot;AssumedRoleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AROA36C6WWEJULFUYMPB6:abc&quot;</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">        </span><span class="nt">&quot;Arn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:sts::123456789012:assumed-role/eksctl-winterfell-addon-iamserviceaccount-de-Role1-1D61LT75JH3MB/abc&quot;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="nt">&quot;Audience&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sts.amazonaws.com&quot;</span><span class="p">,</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="nt">&quot;Provider&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/D43CF17C27A865933144EA99A26FB128&quot;</span><span class="p">,</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">    </span><span class="nt">&quot;SubjectFromWebIdentityToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:s3-read-only&quot;</span><span class="p">,</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="nt">&quot;Credentials&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">        </span><span class="nt">&quot;SecretAccessKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORJ+8Adk+wW+nU8FETq7+mOqeA8Z6jlPihnV8hX1&quot;</span><span class="p">,</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">        </span><span class="nt">&quot;SessionToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;FwoGZXIvYXdzEGMaDMLxAZkuLpmSwYXShiL9A1S0X87VBC1mHCrRe/pB2oes+l1eXxUYnPJyC9ayOoXMvqXQsomq0xs6OqZ3vaa5Iw1HIyA4Cv1suLaOCoU3hNvOIJ6C94H1vU0siQYk7DIq9Av5RZe+uE2FnOctNBvYLd3i0IZo1ajjc00yRK3v24VRq9nQpoPLuqyH2jzlhCEjXuPScPbi5KEVs9fNcOTtgzbVf7IG2gNiwNs5aCpN4Bv/Zv2A6zp5xGz9cWj2f0aD9v66vX4bexOs5t/YYhwuwAvkkJPSIGvxja0xRThnceHyFHKtj0H+bi/PWAtlI8YJcDX69cM30JAHDdQH+ltm/4scFptW1hlvMaP+WReCAaCrsHrAT+yka7ttw5YlUyvZ8EPog+j6fwHlxmrXM9h1BqdikomyJU00gm1++FJelfP+1zAwcyrxCnbRl3ARFrAt8hIlrT6Vyu8WvWtLxcI8KcLcJQb/LgkW+sCTGlYcY8z3zkigJMbYn07ewTL5Ss7LazTJJa758I7PZan/v3xQHd5DEc5WBneiV3iOznDFgup0VAMkIviVjVCkszaPSVEdK2NU7jtrh6Jfm7bU/3P6ZG+CkyDLIa8MBn9KPXeJd/y+jTk5Ii+fIwO/+mDpGNUribg6TPxhzZ8b/XdZO1kS1gVgqjXyVC+M+BRBh6C4H21w/eMzjCtDIpoxt5rGKL6Nu/IFMipoC4fgx6LIIHwtGYMG7SWQi7OsMAkiwZRg0n68/RqWgLzBt/4pfjSRYuk=&quot;</span><span class="p">,</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">        </span><span class="nt">&quot;Expiration&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-02-20T18:49:50Z&quot;</span><span class="p">,</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">        </span><span class="nt">&quot;AccessKeyId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;XXXX36C6WWEJUMHA3L7Z&quot;</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="p">}</span>
</code></pre></div>
<p>EKS 控制平面的一個變異 Webhook 將 AWS 角色 ARN 和 Web 身分令牌文件的路徑注入到 Pod 作為環境變數。這些值也可以手動提供。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nv">AWS_ROLE_ARN</span><span class="o">=</span>arn:aws:iam::AWS_ACCOUNT_ID:role/IAM_ROLE_NAME
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nv">AWS_WEB_IDENTITY_TOKEN_FILE</span><span class="o">=</span>/var/run/secrets/eks.amazonaws.com/serviceaccount/token
</code></pre></div>
<p>kubelet 將在令牌超過其總 TTL 的 80% 或 24 小時後自動輪換投射的令牌。AWS SDK 負責在令牌輪換時重新加載令牌。有關 IRSA 的更多資訊,請參見 <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html">https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html</a>。</p>
<h3 id="eks-pod">EKS Pod 身分<a class="headerlink" href="#eks-pod" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-identities.html">EKS Pod 身分</a>是一項在 re:Invent 2023 推出的功能,允許您將 IAM 角色分配給 kubernetes 服務帳戶,而無需為您的 AWS 帳戶中的每個叢集配置 Open Id Connect (OIDC) 身分提供程式(IDP)。要使用 EKS Pod 身分,您必須部署一個代理程式,該代理程式作為 DaemonSet pod 在每個合格的工作節點上運行。此代理程式作為 EKS 附加元件提供給您,是使用 EKS Pod 身分功能的先決條件。您的應用程式必須使用<a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-minimum-sdk.html">受支援版本的 AWS SDK</a>才能使用此功能。</p>
<p>當為 Pod 配置了 EKS Pod 身分時,EKS 將在 <code>/var/run/secrets/pods.eks.amazonaws.com/serviceaccount/eks-pod-identity-token</code> 掛載和刷新 pod 身分令牌。此令牌將由 AWS SDK 用於與 EKS Pod 身分代理程式通信,該代理程式使用 pod 身分令牌和代理程式的 IAM 角色來通過調用 <a href="https://docs.aws.amazon.com/eks/latest/APIReference/API_auth_AssumeRoleForPodIdentity.html">AssumeRoleForPodIdentity API</a>為您的 pod 創建臨時憑證。傳遞給您的 pod 的 pod 身分令牌是從您的 EKS 叢集發出的 JWT,並經過加密簽名,具有適合 EKS Pod 身分使用的 JWT 聲明。</p>
<p>要了解更多關於 EKS Pod 身分的信息,請參見<a href="https://aws.amazon.com/blogs/containers/amazon-eks-pod-identity-a-new-way-for-applications-on-eks-to-obtain-iam-credentials/">這篇博客</a>。</p>
<p>您不需要對您的應用程式代碼進行任何修改就可以使用 EKS Pod 身分。受支援的 AWS SDK 版本將自動通過使用<a href="https://docs.aws.amazon.com/sdkref/latest/guide/standardized-credentials.html">憑證提供程式鏈</a>發現使用 EKS Pod 身分提供的憑證。與 IRSA 一樣,EKS pod 身分在您的 pod 中設置變數,指示它們如何找到 AWS 憑證。</p>
<h4 id="iam-eks-pod">使用 IAM 角色進行 EKS Pod 身分<a class="headerlink" href="#iam-eks-pod" title="Permanent link">&para;</a></h4>
<ul>
<li>EKS Pod 身分只能直接承擔與 EKS 叢集相同 AWS 帳戶中的 IAM 角色。要訪問另一個 AWS 帳戶中的 IAM 角色,您必須通過<a href="https://docs.aws.amazon.com/sdkref/latest/guide/feature-assume-role-credentials.html">在 SDK 配置中配置一個配置文件</a>或<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/sts_example_sts_AssumeRole_section.html">在應用程式的代碼中</a>來承擔該角色。</li>
<li>當為服務帳戶配置 EKS Pod 身分時,配置 Pod 身分關聯的人或過程必須對該角色具有 <code>iam:PassRole</code> 授權。</li>
<li>每個服務帳戶最多只能與一個 IAM 角色通過 EKS Pod 身分相關聯,但您可以將同一 IAM 角色與多個服務帳戶相關聯。</li>
<li>與 EKS Pod 身分一起使用的 IAM 角色必須允許 <code>pods.eks.amazonaws.com</code> 服務主體承擔它們,_並且_設置會話標籤。以下是一個示例角色信任策略,允許 EKS Pod 身分使用 IAM 角色:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="p">{</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">  </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">  </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">      </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">      </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">        </span><span class="nt">&quot;Service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pods.eks.amazonaws.com&quot;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">      </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">        </span><span class="s2">&quot;sts:AssumeRole&quot;</span><span class="p">,</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">        </span><span class="s2">&quot;sts:TagSession&quot;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">      </span><span class="p">],</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">      </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">        </span><span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">          </span><span class="nt">&quot;aws:SourceOrgId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${aws:ResourceOrgId}&quot;</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="p">}</span>
</code></pre></div>
<p>AWS 建議使用像 <code>aws:SourceOrgId</code> 這樣的條件鍵來幫助防範<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html#cross-service-confused-deputy-prevention">跨服務混淆代理問題</a>。在上面的示例角色信任策略中,<code>ResourceOrgId</code> 是一個等於 AWS 組織 ID 的變數,該 ID 是 AWS 組織的 ID,AWS 帳戶屬於該組織。EKS 將在使用 EKS Pod 身分承擔角色時傳入 <code>aws:SourceOrgId</code> 的值。</p>
<h4 id="abac-eks-pod">ABAC 和 EKS Pod 身分<a class="headerlink" href="#abac-eks-pod" title="Permanent link">&para;</a></h4>
<p>當 EKS Pod 身分承擔 IAM 角色時,它會設置以下會話標籤:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">EKS Pod 身分會話標籤</th>
<th style="text-align: left;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">kubernetes-namespace</td>
<td style="text-align: left;">pod 與 EKS Pod 身分關聯的命名空間。</td>
</tr>
<tr>
<td style="text-align: left;">kubernetes-service-account</td>
<td style="text-align: left;">與 EKS Pod 身分關聯的 kubernetes 服務帳戶名稱</td>
</tr>
<tr>
<td style="text-align: left;">eks-cluster-arn</td>
<td style="text-align: left;">EKS 叢集的 ARN,例如 <code>arn:${Partition}:eks:${Region}:${Account}:cluster/${ClusterName}</code>。叢集 ARN 是唯一的,但如果在同一 AWS 帳戶中的同一區域內刪除並重新創建具有相同名稱的叢集,它將具有相同的 ARN。</td>
</tr>
<tr>
<td style="text-align: left;">eks-cluster-name</td>
<td style="text-align: left;">EKS 叢集的名稱。請注意,EKS 叢集名稱可以在您的 AWS 帳戶內相同,並且 EKS 叢集可以在其他 AWS 帳戶中。</td>
</tr>
<tr>
<td style="text-align: left;">kubernetes-pod-name</td>
<td style="text-align: left;">EKS 中 pod 的名稱。</td>
</tr>
<tr>
<td style="text-align: left;">kubernetes-pod-uid</td>
<td style="text-align: left;">EKS 中 pod 的 UID。</td>
</tr>
</tbody>
</table>
<p>這些會話標籤允許您使用<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction_attribute-based-access-control.html">屬性型存取控制(ABAC)</a>向特定 kubernetes 服務帳戶授予對您的 AWS 資源的訪問權限。在這樣做時,_非常重要_的是要理解 kubernetes 服務帳戶只在命名空間內是唯一的,而 kubernetes 命名空間只在 EKS 叢集內是唯一的。可以通過使用全局條件鍵 <code>aws:PrincipalTag/&lt;tag-key&gt;</code> 如 <code>aws:PrincipalTag/eks-cluster-arn</code> 在 AWS 策略中訪問這些會話標籤。</p>
<p>例如,如果您想授予對帳戶中 AWS 資源的訪問權限,只授予特定服務帳戶,您需要檢查 <code>eks-cluster-arn</code> 和 <code>kubernetes-namespace</code> 標籤,以及 <code>kubernetes-service-account</code>,以確保只有來自預期叢集的該服務帳戶有權訪問該資源,因為其他叢集可能具有相同的 <code>kubernetes-service-accounts</code> 和 <code>kubernetes-namespaces</code>。</p>
<p>此示例 S3 Bucket 策略只授予對附加該策略的 S3 存儲桶中對象的訪問權限,前提是 <code>kubernetes-service-account</code>、<code>kubernetes-namespace</code>、<code>eks-cluster-arn</code> 都符合預期值,其中 EKS 叢集託管在 AWS 帳戶 <code>111122223333</code> 中。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">            </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">                </span><span class="nt">&quot;AWS&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::111122223333:root&quot;</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">            </span><span class="p">},</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3:*&quot;</span><span class="p">,</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">            </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w">            </span><span class="p">[</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">                </span><span class="s2">&quot;arn:aws:s3:::ExampleBucket/*&quot;</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">            </span><span class="p">],</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">            </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">                </span><span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">                    </span><span class="nt">&quot;aws:PrincipalTag/kubernetes-service-account&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3objectservice&quot;</span><span class="p">,</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">                    </span><span class="nt">&quot;aws:PrincipalTag/eks-cluster-arn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:eks:us-west-2:111122223333:cluster/ProductionCluster&quot;</span><span class="p">,</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">                    </span><span class="nt">&quot;aws:PrincipalTag/kubernetes-namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3datanamespace&quot;</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="p">}</span>
</code></pre></div>
<h3 id="eks-pod-irsa">EKS Pod 身分與 IRSA 的比較<a class="headerlink" href="#eks-pod-irsa" title="Permanent link">&para;</a></h3>
<p>EKS Pod 身分和 IRSA 都是向 EKS pod 提供臨時 AWS 憑證的首選方式。除非您有特定的 IRSA 用例,否則我們建議您在使用 EKS 時使用 EKS Pod 身分。下表有助於比較這兩個功能。</p>
<table>
<thead>
<tr>
<th style="text-align: left;">#</th>
<th style="text-align: left;">EKS Pod 身分</th>
<th style="text-align: left;">IRSA</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">需要在您的 AWS 帳戶中創建 OIDC IDP 的權限嗎?</td>
<td style="text-align: left;">否</td>
<td style="text-align: left;">是</td>
</tr>
<tr>
<td style="text-align: left;">每個叢集需要唯一的 IDP 設置嗎</td>
<td style="text-align: left;">否</td>
<td style="text-align: left;">是</td>
</tr>
<tr>
<td style="text-align: left;">為 ABAC 設置相關會話標籤</td>
<td style="text-align: left;">是</td>
<td style="text-align: left;">否</td>
</tr>
<tr>
<td style="text-align: left;">需要 iam:PassRole 檢查嗎?</td>
<td style="text-align: left;">是</td>
<td style="text-align: left;">否</td>
</tr>
<tr>
<td style="text-align: left;">使用您 AWS 帳戶的 AWS STS 配額?</td>
<td style="text-align: left;">否</td>
<td style="text-align: left;">是</td>
</tr>
<tr>
<td style="text-align: left;">可以訪問其他 AWS 帳戶</td>
<td style="text-align: left;">間接通過角色鏈</td>
<td style="text-align: left;">直接通過 sts:AssumeRoleWithWebIdentity</td>
</tr>
<tr>
<td style="text-align: left;">與 AWS SDK 兼容</td>
<td style="text-align: left;">是</td>
<td style="text-align: left;">是</td>
</tr>
<tr>
<td style="text-align: left;">需要 Pod 身分代理 Daemonset 在節點上嗎?</td>
<td style="text-align: left;">是</td>
<td style="text-align: left;">否</td>
</tr>
</tbody>
</table>
<h2 id="eks-pods_1">EKS Pods 的身分和憑證建議<a class="headerlink" href="#eks-pods_1" title="Permanent link">&para;</a></h2>
<h3 id="aws-node-daemonset-irsa">將 aws-node daemonset 更新為使用 IRSA<a class="headerlink" href="#aws-node-daemonset-irsa" title="Permanent link">&para;</a></h3>
<p>目前,aws-node daemonset 配置為使用分配給 EC2 實例的角色來分配 IP 到 pod。此角色包括幾個 AWS 管理的策略,例如 AmazonEKS_CNI_Policy 和 EC2ContainerRegistryReadOnly,實際上允許在節點上運行的<strong>所有</strong> pod 附加/分離 ENI、分配/取消分配 IP 地址或從 ECR 拉取映像。由於這會對您的叢集構成風險,建議您將 aws-node daemonset 更新為使用 IRSA。可以在本指南的<a href="https://github.com/aws/aws-eks-best-practices/tree/master/projects/enable-irsa/src">存儲庫</a>中找到一個用於此目的的腳本。</p>
<p>aws-node daemonset 目前不支持 EKS Pod 身分。</p>
<h3 id="_8">限制分配給工作節點的實例配置文件的訪問權限<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>當您使用 IRSA 或 EKS Pod 身分時,它會更新 pod 的憑證鏈以首先使用 IRSA 或 EKS Pod 身分,但 pod <em>仍然可以繼承分配給工作節點的實例配置文件的權限</em>。使用 IRSA 或 EKS Pod 身分時,<strong>強烈</strong>建議您阻止對<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">實例元數據</a>的訪問,以確保您的應用程序只有它們所需的權限,而不是它們的節點。</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>阻止對實例元數據的訪問將防止不使用 IRSA 或 EKS Pod 身分的 pod 繼承分配給工作節點的角色。</p>
</div>
<p>您可以通過要求實例僅使用 IMDSv2 並更新跳躍計數到 1 來阻止對實例元數據的訪問,如下例所示。您也可以將這些設置包含在節點組的啟動模板中。<strong>不要</strong>禁用實例元數據,因為這將阻止依賴實例元數據的組件(如節點終止處理程序)正常工作。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>$<span class="w"> </span>aws<span class="w"> </span>ec2<span class="w"> </span>modify-instance-metadata-options<span class="w"> </span>--instance-id<span class="w"> </span>&lt;value&gt;<span class="w"> </span>--http-tokens<span class="w"> </span>required<span class="w"> </span>--http-put-response-hop-limit<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>...
</code></pre></div>
<p>如果您使用 Terraform 為托管節點組創建啟動模板,請將元數據塊添加到配置跳躍計數,如此代碼片段所示:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_launch_template&quot;</span><span class="w"> </span><span class="nv">&quot;foo&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;foo&quot;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="nb">metadata_options</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="na">http_endpoint</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;enabled&quot;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="na">http_tokens</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;required&quot;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="hll"><span class="w">    </span><span class="na">http_put_response_hop_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">    </span><span class="na">instance_metadata_tags</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;enabled&quot;</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">  </span><span class="p">...</span>
</code></pre></div>
<p>您還可以通過操縱節點上的 iptables 來阻止 pod 訪問 EC2 元數據。有關此方法的更多資訊,請參見<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html#instance-metadata-limiting-access">限制對實例元數據服務的訪問</a>。</p>
<p>如果您有一個使用較舊版本 AWS SDK 的應用程序,該 SDK 不支持 IRSA 或 EKS Pod 身分,您應該更新 SDK 版本。</p>
<h3 id="irsa">將 IRSA 角色的信任策略範圍縮小到服務帳戶名稱、命名空間和叢集<a class="headerlink" href="#irsa" title="Permanent link">&para;</a></h3>
<p>信任策略可以範圍縮小到命名空間或命名空間中的特定服務帳戶。使用 IRSA 時,最好通過包括服務帳戶名稱來使角色信任策略盡可能明確。這將有效防止同一命名空間中的其他 Pod 承擔該角色。<code>eksctl</code> 會在您使用它創建服務帳戶/IAM 角色時自動執行此操作。有關更多資訊,請參見 <a href="https://eksctl.io/usage/iamserviceaccounts/">https://eksctl.io/usage/iamserviceaccounts/</a>。</p>
<p>在直接使用 IAM 時,這是在角色的信任策略中添加一個條件,使用條件來確保 <code>:sub</code> 聲明是您期望的命名空間和服務帳戶。例如,在我們有一個 IRSA 令牌的 sub 聲明為"system:serviceaccount:default:s3-read-only"之前。這是 <code>default</code> 命名空間,服務帳戶是 <code>s3-read-only</code>。您將使用如下條件來確保只有您的叢集中給定命名空間中的服務帳戶才能承擔該角色:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="w">  </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">      </span><span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">          </span><span class="nt">&quot;oidc.eks.us-west-2.amazonaws.com/id/D43CF17C27A865933144EA99A26FB128:aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sts.amazonaws.com&quot;</span><span class="p">,</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">          </span><span class="nt">&quot;oidc.eks.us-west-2.amazonaws.com/id/D43CF17C27A865933144EA99A26FB128:sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:s3-read-only&quot;</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="iam_2">每個應用程序使用一個 IAM 角色<a class="headerlink" href="#iam_2" title="Permanent link">&para;</a></h3>
<p>對於 IRSA 和 EKS Pod 身分,最佳實踐是為每個應用程序提供一個自己的 IAM 角色。這可以提高隔離性,因為您可以修改一個應用程序而不影響另一個,並允許您應用最小特權原則,只授予應用程序所需的權限。</p>
<p>使用 EKS Pod 身分時,如果您使用 ABAC,您可以跨多個服務帳戶使用一個通用的 IAM 角色,並依賴它們的會話屬性進行訪問控制。當以大規模運營時,ABAC 允許您使用較少的 IAM 角色。</p>
<h3 id="imds-imdsv2-ec2-2">當您的應用程序需要訪問 IMDS 時,請使用 IMDSv2 並增加 EC2 實例的跳躍限制到 2<a class="headerlink" href="#imds-imdsv2-ec2-2" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">IMDSv2</a> 要求您使用 PUT 請求來獲取會話令牌。初始 PUT 請求必須包含會話令牌的 TTL。較新版本的 AWS SDK 將自動處理這個問題以及對該令牌的更新。還要注意,EC2 實例上的默認跳躍限制為 1,以防止 IP 轉發。因此,在 EC2 實例上運行的請求會話令牌的 Pod 可能最終會超時,並退回到使用 IMDSv1 數據流。EKS 通過_啟用_v1 和 v2 並將跳躍限制更改為 2 來添加對 IMDSv2 的支持,這是由 eksctl 或官方 CloudFormation 模板配置的節點。</p>
<h3 id="_9">禁用服務帳戶令牌的自動掛載<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>如果您的應用程序不需要調用 Kubernetes API,請在應用程序的 PodSpec 中將 <code>automountServiceAccountToken</code> 屬性設置為 <code>false</code>,或者修補每個命名空間中的默認服務帳戶,使其不會自動掛載到 pod 上。例如:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>serviceaccount<span class="w"> </span>default<span class="w"> </span>-p<span class="w"> </span><span class="s1">$&#39;automountServiceAccountToken: false&#39;</span>
</code></pre></div>
<h3 id="_10">為每個應用程序使用專用的服務帳戶<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>每個應用程序都應該有自己的專用服務帳戶。這適用於 Kubernetes API 的服務帳戶以及 IRSA 和 EKS Pod 身分。</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>如果您在使用 IRSA 時採用藍/綠集群升級方法,而不是執行就地集群升級,則需要更新每個 IRSA IAM 角色的信任策略,以包含新集群的 OIDC 端點。藍/綠集群升級是指您在現有集群旁邊創建一個運行較新 Kubernetes 版本的集群,並使用負載均衡器或服務網格無縫地將流量從在舊集群上運行的服務轉移到新集群。
當使用藍/綠集群升級與 EKS Pod 身分時,您將在新集群中創建 pod 身分關聯,並更新 IAM 角色信任策略(如果有 <code>sourceArn</code> 條件)。</p>
</div>
<h3 id="root">以非 root 用戶運行應用程序<a class="headerlink" href="#root" title="Permanent link">&para;</a></h3>
<p>容器默認以 root 用戶運行。雖然這允許它們讀取 Web 身分令牌文件,但以 root 用戶運行容器不被視為最佳實踐。作為替代方案,請考慮在 PodSpec 中添加 <code>spec.securityContext.runAsUser</code> 屬性。 <code>runAsUser</code> 的值是任意值。</p>
<p>在以下示例中,Pod 中的所有進程都將在 <code>runAsUser</code> 字段中指定的用戶 ID 下運行。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security-context-demo</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">    </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sec-ctx-demo</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;sleep</span><span class="nv"> </span><span class="s">1h&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>當您以非 root 用戶運行容器時,它會防止容器讀取 IRSA 服務帳戶令牌,因為該令牌默認具有 0600 [root] 權限。如果您更新容器的 securityContext 以包括 fsgroup=65534 [Nobody],它將允許容器讀取令牌。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65534</span>
</code></pre></div>
<p>在 Kubernetes 1.19 及更高版本中,不再需要此更改,應用程序可以在不將它們添加到 Nobody 組的情況下讀取 IRSA 服務帳戶令牌。</p>
<h3 id="_11">向應用程序授予最小特權訪問權限<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/princespaghetti/actionhero">Action Hero</a> 是一個您可以與您的應用程序一起運行的實用程序,可以識別您的應用程序需要的 AWS API 調用和相應的 IAM 權限。它類似於 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_access-advisor.html">IAM Access Advisor</a>,因為它可以幫助您逐步限制分配給應用程序的 IAM 角色的範圍。有關授予 AWS 資源<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege">最小特權訪問</a>的更多資訊,請參閱文檔。</p>
<p>考慮在 IRSA 和 Pod 身分使用的 IAM 角色上設置<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html">權限邊界</a>。您可以使用權限邊界來確保 IRSA 或 Pod 身分使用的角色不能超過最大權限級別。有關使用權限邊界的入門指南和示例權限邊界策略,請參見<a href="https://github.com/aws-samples/example-permissions-boundary">此 github 存儲庫</a>。</p>
<h3 id="eks_2">審查並撤銷對您的 EKS 叢集的不必要的匿名訪問<a class="headerlink" href="#eks_2" title="Permanent link">&para;</a></h3>
<p>理想情況下,應該禁用所有 API 操作的匿名訪問。匿名訪問是通過為 Kubernetes 內置用戶 system:anonymous 創建 RoleBinding 或 ClusterRoleBinding 來授予的。您可以使用 <a href="https://github.com/FairwindsOps/rbac-lookup">rbac-lookup</a> 工具來識別 system:anonymous 用戶在您的叢集上擁有的權限:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>./rbac-lookup<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s1">&#39;system:(anonymous)|(unauthenticated)&#39;</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>system:anonymous<span class="w">               </span>cluster-wide<span class="w">        </span>ClusterRole/system:discovery
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>system:unauthenticated<span class="w">         </span>cluster-wide<span class="w">        </span>ClusterRole/system:discovery
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>system:unauthenticated<span class="w">         </span>cluster-wide<span class="w">        </span>ClusterRole/system:public-info-viewer
</code></pre></div>
<p>除了 system:public-info-viewer 之外,任何其他角色或 ClusterRole 都不應綁定到 system:anonymous 用戶或 system:unauthenticated 組。</p>
<p>可能有一些合法的理由允許對特定 API 的匿名訪問。如果這適用於您的叢集,請確保只有那些特定的 API 可以由匿名用戶訪問,並且在沒有驗證的情況下公開這些 API 不會使您的叢集容易受到攻擊。</p>
<p>在 Kubernetes/EKS 版本 1.14 之前,system:unauthenticated 組默認與 system:discovery 和 system:basic-user ClusterRoles 相關聯。請注意,即使您已將叢集更新到 1.14 或更高版本,這些權限可能仍然啟用在您的叢集上,因為叢集更新不會撤銷這些權限。
要檢查除 system:public-info-viewer 之外哪些 ClusterRoles 有 "system:unauthenticated",您可以運行以下命令(需要 jq 工具):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ClusterRoleBinding<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[] | select(.subjects[]?.name ==&quot;system:unauthenticated&quot;) | select(.metadata.name != &quot;system:public-info-viewer&quot;) | .metadata.name&#39;</span>
</code></pre></div>
<p>並且可以使用以下命令從除 "system:public-info-viewer" 之外的所有角色中刪除 "system:unauthenticated":</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ClusterRoleBinding<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[] | select(.subjects[]?.name ==&quot;system:unauthenticated&quot;) | select(.metadata.name != &quot;system:public-info-viewer&quot;) | del(.subjects[] | select(.name ==&quot;system:unauthenticated&quot;))&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-
</code></pre></div>
<p>或者,您可以手動檢查和刪除。要檢查 system:unauthenticated 組是否具有 system:discovery 權限,請運行以下命令:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>kubectl<span class="w"> </span>describe<span class="w"> </span>clusterrolebindings<span class="w"> </span>system:discovery
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>Name:<span class="w">         </span>system:discovery
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>Labels:<span class="w">       </span>kubernetes.io/bootstrapping<span class="o">=</span>rbac-defaults
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>Annotations:<span class="w">  </span>rbac.authorization.kubernetes.io/autoupdate:<span class="w"> </span><span class="nb">true</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>Role:
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">  </span>Kind:<span class="w">  </span>ClusterRole
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">  </span>Name:<span class="w">  </span>system:discovery
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>Subjects:
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">  </span>Kind<span class="w">   </span>Name<span class="w">                    </span>Namespace
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">  </span>----<span class="w">   </span>----<span class="w">                    </span>---------
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">  </span>Group<span class="w">  </span>system:authenticated
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">  </span>Group<span class="w">  </span>system:unauthenticated
</code></pre></div>
<p>要檢查 system:unauthenticated 組是否具有 system:basic-user 權限,請運行以下命令:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>kubectl<span class="w"> </span>describe<span class="w"> </span>clusterrolebindings<span class="w"> </span>system:basic-user
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>Name:<span class="w">         </span>system:basic-user
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>Labels:<span class="w">       </span>kubernetes.io/bootstrapping<span class="o">=</span>rbac-defaults
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>Annotations:<span class="w">  </span>rbac.authorization.kubernetes.io/autoupdate:<span class="w"> </span><span class="nb">true</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>Role:
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">  </span>Kind:<span class="w">  </span>ClusterRole
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">  </span>Name:<span class="w">  </span>system:basic-user
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>Subjects:
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">  </span>Kind<span class="w">   </span>Name<span class="w">                    </span>Namespace
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">  </span>----<span class="w">   </span>----<span class="w">                    </span>---------
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">  </span>Group<span class="w">  </span>system:authenticated
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">  </span>Group<span class="w">  </span>system:unauthenticated
</code></pre></div>
<p>如果 system:unauthenticated 組綁定到 system:discovery 和/或 system:basic-user ClusterRoles,您應該將這些角色與 system:unauthenticated 組分離。使用以下命令編輯 system:discovery ClusterRoleBinding:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>kubectl<span class="w"> </span>edit<span class="w"> </span>clusterrolebindings<span class="w"> </span>system:discovery
</code></pre></div>
<p>上述命令將在編輯器中打開 system:discovery ClusterRoleBinding 的當前定義,如下所示:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="c1"># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="c1"># reopened with the relevant failures.</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="c1">#</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">    </span><span class="nt">rbac.authorization.kubernetes.io/autoupdate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-06-17T20:50:49Z&quot;</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">    </span><span class="nt">kubernetes.io/bootstrapping</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac-defaults</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:discovery</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24502985&quot;</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Adiscovery</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">b7936268-5043-431a-a0e1-171a423abeb6</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="nt">roleRef</span><span class="p">:</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:discovery</span>
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="nt">subjects</span><span class="p">:</span>
<a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Group</span>
<a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:authenticated</span>
<a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Group</span>
<a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:unauthenticated</span>
</code></pre></div>
<p>從上面的編輯器屏幕中的"subjects"部分刪除 system:unauthenticated 組的條目。</p>
<p>對 system:basic-user ClusterRoleBinding 重複相同的步驟。</p>
<h3 id="irsa-aws-sdk">與 IRSA 一起重複使用 AWS SDK 會話<a class="headerlink" href="#irsa-aws-sdk" title="Permanent link">&para;</a></h3>
<p>當您使用 IRSA 時,使用 AWS SDK 編寫的應用程序使用傳遞到 pod 的令牌來調用 <code>sts:AssumeRoleWithWebIdentity</code> 以生成臨時 AWS 憑證。這與其他 AWS 計算服務不同,在其他 AWS 計算服務中,計算服務直接向 AWS 計算資源(如 lambda 函數)提供臨時 AWS 憑證。這意味著每次初始化 AWS SDK 會話時,都會進行一次 <code>AssumeRoleWithWebIdentity</code> 的 AWS STS 調用。如果您的應用程序快速擴展並初始化多個 AWS SDK 會話,您可能會遇到來自 AWS STS 的節流,因為您的代碼將進行大量 <code>AssumeRoleWithWebIdentity</code> 調用。</p>
<p>為了避免這種情況,我們建議在應用程序中重複使用 AWS SDK 會話,以避免不必要的 <code>AssumeRoleWithWebIdentity</code> 調用。</p>
<p>在以下示例代碼中,使用 boto3 python SDK 創建一個會話,並使用該會話創建客戶端與 Amazon S3 和 Amazon SQS 進行交互。<code>AssumeRoleWithWebIdentity</code> 只被調用一次,AWS SDK 將在憑證過期時自動刷新 <code>my_session</code> 的憑證。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kn">import</span> <span class="nn">boto3</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="c1"># 創建您自己的會話</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="hll"><span class="n">my_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="c1"># 現在我們可以從我們的會話創建低級客戶端</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="hll"><span class="n">sqs</span> <span class="o">=</span> <span class="n">my_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>
</span><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="hll"><span class="n">s3</span> <span class="o">=</span> <span class="n">my_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
</span><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="n">s3response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="n">sqsresponse</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">list_queues</span><span class="p">()</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="c1">#打印來自 S3 和 SQS API 的響應</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s3 response:&quot;</span><span class="p">)</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="nb">print</span><span class="p">(</span><span class="n">s3response</span><span class="p">)</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sqs response:&quot;</span><span class="p">)</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="nb">print</span><span class="p">(</span><span class="n">sqsresponse</span><span class="p">)</span>
</code></pre></div>
<p>如果您正在將應用程序從另一個 AWS 計算服務(如 EC2)遷移到使用 IRSA 的 EKS,這一點尤其重要。在其他計算服務上,初始化 AWS SDK 會話不會調用 AWS STS,除非您指示它這樣做。</p>
<h3 id="_12">替代方法<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>雖然 IRSA 和 EKS Pod 身分是_首選方式_來為 pod 分配 AWS 身分,但它們要求您在應用程序中包含 AWS SDK 的最新版本。有關目前支持 IRSA 的 SDK 的完整列表,請參見 <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-minimum-sdk.html">https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-minimum-sdk.html</a>,對於 EKS Pod 身分,請參見 <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-minimum-sdk.html">https://docs.aws.amazon.com/eks/latest/userguide/pod-id-minimum-sdk.html</a>。如果您有一個應用程序無法立即更新為兼容的 SDK,社區中有幾個可用的解決方案,用於將 IAM 角色分配給 Kubernetes pod,包括 <a href="https://github.com/jtblin/kube2iam">kube2iam</a> 和 <a href="https://github.com/uswitch/kiam">kiam</a>。儘管 AWS 不支持、不贊同或支持使用這些解決方案,但它們被社區廣泛使用,以實現與 IRSA 和 EKS Pod 身分類似的結果。</p>
<p>如果您需要使用這些非 AWS 提供的解決方案,請仔細考慮這樣做的安全影響。</p>
<h2 id="_13">工具和資源<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://catalog.workshops.aws/eks-security-immersionday/en-US/2-identity-and-access-management">Amazon EKS 安全沉浸式研討會 - 身分和存取管理</a></li>
<li><a href="https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/patterns/fully-private-cluster">Terraform EKS 藍圖模式 - 完全私有的 Amazon EKS 叢集</a></li>
<li><a href="https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/patterns/sso-iam-identity-center">Terraform EKS 藍圖模式 - IAM 身分中心單點登錄 Amazon EKS 叢集</a></li>
<li><a href="https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/patterns/sso-okta">Terraform EKS 藍圖模式 - Okta 單點登錄 Amazon EKS 叢集</a></li>
<li><a href="https://github.com/liggitt/audit2rbac">audit2rbac</a></li>
<li><a href="https://github.com/mhausenblas/rbac.dev">rbac.dev</a> Kubernetes RBAC 的其他資源列表,包括博客和工具</li>
<li><a href="https://github.com/princespaghetti/actionhero">Action Hero</a></li>
<li><a href="https://github.com/jtblin/kube2iam">kube2iam</a></li>
<li><a href="https://github.com/uswitch/kiam">kiam</a></li>
</ul>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["tabs", "content.code.copy", "announce.dismiss", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.bd41221c.min.js"></script>
      
    
  </body>
</html>